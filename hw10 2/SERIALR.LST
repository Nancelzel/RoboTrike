8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE SERIALR
OBJECT MODULE PLACED IN SERIALR.OBJ
ASSEMBLER INVOKED BY:  C:\UTIL\ASM86.EXE SERIALR.ASM M1 EP DB


LOC  OBJ                  LINE     SOURCE

                             1     NAME    SERIALR
                             2     
                             3     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             4     ;                                                                            ;
                             5     ;                                   SERIALR                                  ;
                             6     ;                     RoboTrike Serial Routine Functions                     ;
                             7     ;                                   EE/CS 51                                 ;
                             8     ;                                                                            ;
                             9     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                            10     
                            11     ; Description:       This program includes the RoboTrike serial routine
                            12     ;                    functions. The public functions included are:
                            13     ;                        InitSerial         - initializes the serial (public)
                            14     ;                        SerialPutChar      - loads a char into the serial
                            15     ;                                             queue (public)
                            16     ;                        SetBaudRate        - sets the baud rate (public)
                            17     ;                        SetParity          - sets the parity(public)
                            18     ;                        SerialEventHandler - uses interrupt 2 to check any
                            19     ;                                             interrupts happening, the 4 being
                            20     ;                                             modem, transmitter, data received,
                            21     ;                                             and line status error.
                            22     ;                                             when to check for something in the
                            23     ;                                             queue. Also enqueues errors
                            24     ;                                             from reading the queue.
                            25     ;                        
                            26     ;
                            27     ; Revision History:
                            28     ;     11/17/15  Nancy Cao         initial comments and pseudocode
                            29     ;     11/22/15  Nancy Cao         initial code
                            30     ;     11/24/15  Nancy Cao         finished coding all functions
                            31     ;     11/28/15  Nancy Cao         fixed critical code issues
                            32     ;     11/30/15  Nancy Cao         updated comments
                            33     
                            34     ; local include files
                            35 +1  $INCLUDE(SERIALR.INC)     ; serial constants used for serial I/O Routines
                      =1    36     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    37     ;                                                                            ;
                      =1    38     ;                                  SERIALR.INC                               ;
                      =1    39     ;                         Serial I/O Routine Definitions                     ;
                      =1    40     ;                                 Include File                               ;
                      =1    41     ;                                                                            ;
                      =1    42     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    43     
                      =1    44     ; This file contains the definitions for the serial I/O routine functions.
                      =1    45     ;
                      =1    46     
                      =1    47     ; Addresses
                      =1    48     
  0100                =1    49     SERIAL_BAUD     EQU     100H       ; baud rate generator divisor (R/W)
  0100                =1    50     SERIAL_THR      EQU     100H       ; transmitter holding register (R/W)
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    2


LOC  OBJ                  LINE     SOURCE

  0100                =1    51     SERIAL_RBR      EQU     100H       ; receiver buffer register (R/W)
  0100                =1    52     SERIAL_DLL      EQU     100H
  0101                =1    53     SERIAL_DLM      EQU     101H
  0101                =1    54     SERIAL_IER      EQU     101H       ; interrupt enable register (R/W)
  0102                =1    55     SERIAL_IIR      EQU     102H       ; interrupt identification register (R/W)
  0103                =1    56     SERIAL_LCR      EQU     103H       ; line control register (R/W)
  0104                =1    57     SERIAL_MCR      EQU     104H       ;
  0105                =1    58     SERIAL_LSR      EQU     105H       ; line status register (R/W)
  0106                =1    59     SERIAL_MSR      EQU     106H       ; modem status register (R/W)
  FF22                =1    60     EOI             EQU     0FF22H     ; address of EOI
                      =1    61     
                      =1    62     
                      =1    63     ; Line Control Register
                      =1    64     
  0080                =1    65     ENABLE_BAUD_MASK   EQU     10000000B  ; enable access to the baud rate divisor
  007F                =1    66     DISABLE_BAUD_MASK  EQU     01111111B  ; mask to disable access to the baud rate divis
                                   or
  001C                =1    67     ENABLE_PARITY      EQU     00011100B  ; enable all parity bits
  0002                =1    68     ENABLE_ETBE_MASK   EQU     00000010B  ; enable access to the ETBE
  000D                =1    69     DISABLE_ETBE_MASK  EQU     00001101B  ; mask to disable access to the ETBE
  0003                =1    70     SERIAL_SETUP       EQU     00000011B  ; 0-------  access Rx/Tx data registers
                      =1    71                                           ; -0------  no break output
                      =1    72                                           ; --000---  no parity
                      =1    73                                           ; -----0--  one stop bit
                      =1    74                                           ; ------11  8 data bits
                      =1    75     
                      =1    76     ; Interrupt Enable/Disable Register
                      =1    77     
  0000                =1    78     SERIAL_DIS_IRQ  EQU     00000000B  ; disable all interrupts
  000F                =1    79     SERIAL_IN_IRQ   EQU     00001111B  ; enables the four interrupts:
                      =1    80                                        ; modem status (bit 3)
                      =1    81                                        ; receiver line status (bit 2),
                      =1    82                                        ; transmitter holding register empty (bit 1)
                      =1    83                                        ; receiver data ready/char timeout (bit 0)
                      =1    84                                        
                      =1    85     ; general definitions
                      =1    86     
  0002                =1    87     DEFAULT_BAUD    EQU     2         ; the index of the default baud divisor
  0000                =1    88     DEFAULT_PARITY  EQU     0         ; the index of the parity
  0007                =1    89     IIR_MASK        EQU     111B      ; mask out all the bits of IIR except bottom
                      =1    90                                       ; 3 bits
  001E                =1    91     ERROR_MASK      EQU     00011110B ; used to mask out the error in LSR
  000E                =1    92     EOI_VALUE       EQU     14        ; value of EOI to pass
  0002                =1    93     EVENT_RBR       EQU     2         ; RBR event occured
  0003                =1    94     EVENT_ERROR     EQU     3         ; error event occurd
                            95 +1  $INCLUDE(QUEUE.INC)       ; queue constants used for the queue
                      =1    96     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    97     ;                                                                            ;
                      =1    98     ;                                   QUEUE.INC                                ;
                      =1    99     ;                               Queue Definitions                            ;
                      =1   100     ;                                  Include File                              ;
                      =1   101     ;                                                                            ;
                      =1   102     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1   103     
                      =1   104     ; This file contains the definitions for the queue functions.
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    3


LOC  OBJ                  LINE     SOURCE

                      =1   105     ;
                      =1   106     ; Revision History:
                      =1   107     ;     10/24/15  Nancy Cao      initial revision
                      =1   108     
                      =1   109     ; definitions
  00FF                =1   110     LENGTH_TEST   EQU 255               ; length of the queue
                      =1   111     
                      =1   112     ; Queue structure
                      =1   113     
----                  =1   114     QUEUE         STRUC
0000                  =1   115         headPtr   DB ?                  ; index of head/first element of queue
0001                  =1   116             tailPtr   DB ?                  ; index of tail/last element of queue
0002                  =1   117             len       DW ?                  ; length of queue in bytes
0004                  =1   118             s         DB ?                  ; size of elements in queue (1 or 2 bytes)
0005                  =1   119             array1Ds  DB 256 DUP (?)        ; 1D array designed to hold max 256 bytes
----                  =1   120     QUEUE         ENDS
                           121     
                           122     EXTRN QueueInit:NEAR      ; used to initialize the queue, set the head and the
                           123                               ; tail at appropriate locations
                           124     EXTRN QueueEmpty:NEAR     ; used to check if the queue is empty
                           125     EXTRN QueueFull:NEAR      ; used to check if the queue is full
                           126     EXTRN Dequeue:NEAR        ; used to remove an element from the queue and return
                           127                               ; that element if the queue is not already empty
                           128     EXTRN Enqueue:NEAR        ; used to put an element into the queue if the queue
                           129                               ; is not already full
                           130     EXTRN EnqueueEvent:NEAR   ; enqueues an event and its value to the queue
                           131                               
                           132     EXTRN Baud_Table:WORD     ; baud rate dividers used to get baud rates
                           133     EXTRN Parity_Table:BYTE   ; parity settings for the serial
                           134     
                           135     CGROUP  GROUP   CODE
                           136     DGROUP  GROUP   DATA
                           137     
----                       138     CODE    SEGMENT PUBLIC 'CODE'
                           139     
                           140     
                           141             ASSUME  CS:CGROUP, DS:DGROUP
                           142     
                           143     ; InitSerial
                           144     ; 
                           145     ; Description: This function initializes the serial. The LCR and the IER are
                           146     ;              initialized to SERIAL_SETUP and SERIAL_IN_IRQ. The shared
                           147     ;              variables are also initialized, including the serial chip, the
                           148     ;              baud rate, the parity, and the serial counter used for the event
                           149     ;              handler.
                           150     ;
                           151     ; Operation:   This function first initializes the serial chip registers LCR and
                           152     ;              IER to SERIAL_SETUP (which sets it up the serial to access rx/tx
                           153     ;              data registers, have no break point, no parity, one stoP bit, and
                           154     ;              eight data bits) and SERIAL_IN_IRQ (which enables the four
                           155     ;              interrupts: modem, transmitter, receiver line status, and data
                           156     ;              ready), respectfully. The baud rate is set to be DEFAULT_BAUD,
                           157     ;              and the parity is set to be DEFAULT_PARITY. The kickstart flag is
                           158     ;              set to 0, since there are no interrupts.
                           159     ;
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           160     ; Arguments:        None.
                           161     ; Return Value:     None.
                           162     ; Local Variables:  None.
                           163     ; Shared Variables: baud - the baud rate of the serial (w)
                           164     ;                   parity - the parity of the serial (w)
                           165     ;                   kickstart - the flag that handles interrupts (w)
                           166     ; Global Variables: None.
                           167     ;
                           168     ; Input: None.
                           169     ; Output: None.
                           170     ;
                           171     ; Error Handling: None.
                           172     ;
                           173     ; Limitations: None.
                           174     ;
                           175     ; Algorithms: None.
                           176     ; Data Structures: None.
                           177     ;
                           178     ; Registers Changed: None.
                           179     ;
                           180     ; Author: Nancy Cao
                           181     ; Revision History:
                           182     ;     11/17/15  Nancy Cao        initial comments and pseudocode
                           183     ;     11/22/15  Nancy Cao        initial code and updated comments
                           184     ;     11/30/15  Nancy Cao        updated comments
                           185     ;
                           186     
0000                       187     InitSerial          PROC        NEAR
                           188                         PUBLIC      InitSerial
                           189     
0000                       190     Init82050:                          ; initialize the 82050 serial chip
0000 BA0301                191         MOV     DX, SERIAL_LCR          ; serial LCR address
0003 B003                  192         MOV     AL, SERIAL_SETUP        ; the value to put to LCR
0005 EE                    193         OUT     DX, AL                  ; write SERIAL_SETUP to SERIAL_LCR
                           194     
0006 BA0101                195         MOV     DX, SERIAL_IER          ; serial IER address
0009 B00F                  196         MOV     AL, SERIAL_IN_IRQ       ; the value to put into IER
000B EE                    197         OUT     DX, AL                  ; writes SERIAL_IN_IRQ to SERIAL_IER
                           198                                         ; which turns on the 4 interrupts
                           199             ;JMP    SetSerial               ; set the rest of the serial
                           200     
000C                       201     SetSerial:                          ; set serial parameters
000C BB0200                202         MOV     BX, DEFAULT_BAUD        ; the index of the default Baud rate divisor
000F D1E3                  203         SHL     BX, 1                   ; must shift left since reading word table
0011 E84700                204         CALL    SetBaudRate             ; set the baud rate divisor
0014 BB0000                205         MOV     BX, DEFAULT_PARITY      ; the index of the default parity
0017 E86800                206         CALL    SetParity               ; set the parity of the serial
                           207         ;JMP    InitQueue               ; initialize the queue
                           208     
001A                       209     InitQueue:
001A BE000090       R      210         MOV     SI, OFFSET(tx)      ; pass in address of the transfer queue at DS:SI
001E B9FF00                211         MOV     CX, LENGTH_TEST     ; pass in length of queue
0021 E80000         E      212         CALL    QueueInit           ; initialize an empty queue with head/tails
                           213         ;JMP    InitKickstart       ; initialize kickstart flag
                           214     
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    5


LOC  OBJ                  LINE     SOURCE

0024                       215     InitKickstart:
0024 C60605010090   R      216         MOV kickstart, 0            ; no kickstart since no interrupts
                           217         ;JMP    EndInitSerial       ; finish initializing the serial
                           218     
002A                       219     EndInitSerial:
002A C3                    220         RET
                           221     
                           222     InitSerial    ENDP
                           223     
                           224     ; SerialPutChar
                           225     ;
                           226     ; Description:       This function takes in an eventValue, which is either a
                           227     ;                    character or an error code. The character/error code is
                           228     ;                    enqueued. If the character/error code is successfully
                           229     ;                    enqueued, the carry flag is reset; otherwise it is set,
                           230     ;                    meaning the queue was full. If a character in enqueued,
                           231     ;                    the function checks the kickstart and determines if ETBE
                           232     ;                    should be disabled and then enabled again.
                           233     ;
                           234     ; Operation:         The function first checks if the queue is full. If it is,
                           235     ;                    the carry flag is set, and no character is enqueued, since
                           236     ;                    there is no space. Otherwise, the function will enqueue the
                           237     ;                    character and check kickstart. If the kickstart is set,
                           238     ;                    the ETBE is disabled and then enabled again before the
                           239     ;                    kickstart is unset and the flag is unset.
                           240     ;
                           241     ; Arguments:         eventValue (AL) - either a character received or error code
                           242     ; Return Value:      None.
                           243     ;
                           244     ; Local Variables:   None.
                           245     ; Shared Variables:  None.
                           246     ; Global Variables:  None.
                           247     ;
                           248     ; Input:             None.
                           249     ; Output:            None.
                           250     ;
                           251     ; Error Handling:    None.
                           252     ;
                           253     ; Algorithms:        None.
                           254     ; Data Structures:   Queue.
                           255     ;
                           256     ; Registers Changed: Carry flag, AX, DX, SI
                           257     ;
                           258     ; Author:            Nancy Cao
                           259     ; Revision History:
                           260     ;     11/17/15  Nancy Cao   initial comments and pseudocode
                           261     ;     11/24/15  Nancy Cao   initial code
                           262     ;     11/30/15  Nancy Cao   updated comments
                           263     
002B                       264     SerialPutChar    PROC        NEAR
                           265                      PUBLIC      SerialPutChar
                           266     
002B                       267     CheckQueueFull:
002B BE000090       R      268         MOV SI, OFFSET(tx)    ; pass in address of the transfer queue at DS:SI
002F E80000         E      269         CALL QueueFull        ; check if the queue is full before we try to enqueue
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           270                               ; a char into the queue
0032 7421                  271         JZ SetCarryFlag           ; the zero flag is set which means the queue is full,
                           272                               ; so set the carry flag indicating that a char was
                           273                                                       ; not put into the queue
                           274         ;JMP EnqueueChar       ; otherwise attempt to enqueue the char
                           275     
0034                       276     EnqueueChar:
0034 E80000         E      277             CALL Enqueue          ; enqueue the char
                           278             ;JMP CheckKickstart   ; check if we should kickstart
                           279             
0037                       280     CheckKickstart:
0037 803E050101     R      281             CMP kickstart, 1      ; check if kickstart flag is set
003C 7403                  282         JZ  DisableETBE       ; if so, disable ETBE
003E EB1990                283         JMP FinishPutChar     ; otherwise we are done
                           284     
0041                       285     DisableETBE:
0041 BA0101                286         MOV DX, SERIAL_IER        ; address of SERIAL_IER
0044 EC                    287             IN  AL, DX                ; read in the value stored in IER to disable
0045 240D                  288         AND AL, DISABLE_ETBE_MASK ; clear the ETBE bit in the value
0047 EE                    289         OUT DX, AL                ; put the value back into IER to disable
                           290         ;JMP EnableETBE           ; enable the ETBE again
                           291      
0048                       292     EnableETBE:
0048 C60605010090   R      293         MOV kickstart, 0          ; reset kickstart
004E EC                    294         IN AL, DX                 ; read in the value from IER
004F 0C02                  295         OR AL, ENABLE_ETBE_MASK   ; set the ETBE bit in the value
0051 EE                    296         OUT DX, AL                ; put value back into IER to enable
0052 EB0590                297         JMP FinishPutChar         ; finished with kickstarting
                           298                                     
0055                       299     SetCarryFlag:
0055 F9                    300         STC                   ; set the carry flag to indicate char was not put
0056 EB0290                301             JMP Finish
                           302     
0059                       303     FinishPutChar:
0059 F8                    304         CLC                   ; unset the carry flag to indicate that a char was
                           305                                   ; put into the queue
                           306         ;JMP Finish
                           307                               
005A                       308     Finish:
005A C3                    309             RET
                           310             
                           311     SerialPutChar           ENDP
                           312     
                           313     ; SetBaudRate
                           314     ;
                           315     ; Description:       This function sets the baud rate parameter to its
                           316     ;                    appropriate value.
                           317     ;
                           318     ; Operation:         The function first disables the interrupts to handle the
                           319     ;                    critical code. It changes the value in LCR to set the baud
                           320     ;                    bit. It also sets the DLM and the DLL by shifting the high
                           321     ;                    bit to low bit. It then looks up the baud table to
                           322     ;                    determine the baud rate divisor. Afterwards, the DLAB is
                           323     ;                    then reset and the baud is disabled.
                           324     ;
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    7


LOC  OBJ                  LINE     SOURCE

                           325     ; Arguments:         None.
                           326     ; Return Value:      None.
                           327     ;
                           328     ; Local Variables:   None.
                           329     ; Shared Variables:  baud - the baud of the serial (w)
                           330     ; Global Variables:  None.
                           331     ;
                           332     ; Input:             None.
                           333     ; Output:            None.
                           334     ;
                           335     ; Error Handling:    None.
                           336     ;
                           337     ; Algorithms:        None.
                           338     ; Data Structures:   None.
                           339     ;
                           340     ; Registers Changed: flags, AX, DX
                           341     ;
                           342     ; Author:            Nancy Cao
                           343     ; Revision History:
                           344     ;     11/17/15  Nancy Cao   initial comments and pseudocode
                           345     ;     11/24/16  Nancy Cao   initial code
                           346     ;     11/30/15  Nancy Cao   updated comments
                           347     
005B                       348     SetBaudRate      PROC        NEAR
                           349                      PUBLIC      SetBaudRate
                           350        
005B 9C                    351         PUSHF                 ; save flags
005C FA                    352         CLI                   ; disable interrupts because critical code
                           353         
005D                       354     SetDLAB:      
005D BA0301                355         MOV     DX, SERIAL_LCR          ; get the LCR address to talk to it
0060 EC                    356         IN      AL, DX                  ; read in the value from LCR
0061 0C80                  357         OR      AL, ENABLE_BAUD_MASK    ; change baud bit to be set
0063 EE                    358         OUT     DX, AL                  ; sets DLAB
                           359         ;JMP    WriteBaudDivisor
                           360         
0064                       361     SetDLM:
0064 50                    362         PUSH AX
0065 8AC4                  363         MOV AL, AH                      ; move the high bit to the low bit
0067 BA0101                364         MOV DX, SERIAL_DLM              ; get the address of DLM
006A EE                    365         OUT DX, AL                      ; write in the new value
006B 58                    366         POP AX
                           367         
006C                       368     SetDLL:
006C BA0001                369         MOV DX, SERIAL_DLL              ; get the address of DLL
006F EE                    370         OUT DX, AL                      ; write in the new value
                           371         
0070                       372     WriteBaudDivisor:
0070 BA0001                373         MOV     DX, SERIAL_BAUD         ; set the baud rate divisor
0073 2E8B870000     E      374         MOV     AX, CS:Baud_Table[BX]   ; get baud rate divisor
0078 EF                    375         OUT     DX, AX                  ; write out baud rate divisor
                           376         ;JMP    ResetDLAB  
                           377     
0079                       378     ResetDLAB:
0079 BA0301                379         MOV     DX, SERIAL_LCR          ; talk to the baud rate divisor registers
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    8


LOC  OBJ                  LINE     SOURCE

007C EC                    380         IN      AL, DX                  ; read in the value from LCR
007D 247F                  381         AND     AL, DISABLE_BAUD_MASK   ; clear the ETBE bit in the value
007F EE                    382         OUT     DX, AL                  ; reset DLAB
                           383         ;JMP    FinishedSetBaud
                           384     
0080                       385     FinishSetBaud:
0080 9D                    386         POPF                   ; retreive flags
0081 C3                    387         RET
                           388     
                           389     SetBaudRate           ENDP
                           390     
                           391     ; SetParity
                           392     ;
                           393     ; Description:       This function sets the parity parameter to its appropriate
                           394     ;                    value.
                           395     ;
                           396     ; Operation:         This function reads the current setup in the LCR and resets
                           397     ;                    it, then looks up the specified parity in the parity table
                           398     ;                    before setting it in the LCR value. The new value is then
                           399     ;                    put back in the LCR.
                           400     ;
                           401     ; Arguments:         index (BX) - the index of the parity from the parity table
                           402     ; Return Value:      None.
                           403     ;
                           404     ; Local Variables:   None.
                           405     ; Shared Variables:  parity - the parity of the serial (w)
                           406     ; Global Variables:  None.
                           407     ;
                           408     ; Input:             None.
                           409     ; Output:            None.
                           410     ;
                           411     ; Error Handling:    None.
                           412     ;
                           413     ; Algorithms:        None.
                           414     ; Data Structures:   None.
                           415     ;
                           416     ; Registers Changed: flags, AX, DX
                           417     ;
                           418     ; Author:            Nancy Cao
                           419     ; Revision History:
                           420     ;     11/17/15  Nancy Cao   initial comments and pseudocode
                           421     ;     11/24/15  Nancy Cao   initial code
                           422     ;     11/30/15  Nancy Cao   updated comments
                           423     
0082                       424     SetParity        PROC        NEAR
                           425                      PUBLIC      SetParity
                           426     
0082                       427     ClearParityBits:
0082 BA0301                428         MOV     DX, SERIAL_LCR          ; get the LCR address to talk to it
0085 2E8A870000     E      429         MOV     AL, CS:Parity_Table[BX] ; get the new parity
008A 0C03                  430         OR      AL, SERIAL_SETUP        ; set up serial
008C EE                    431         OUT     DX, AL                  ; set the parity in LCR
                           432         ;JMP    FinishParity
                           433     
008D                       434     FinishParity:
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE    9


LOC  OBJ                  LINE     SOURCE

008D C3                    435         RET
                           436                      
                           437     SetParity    ENDP                 
                           438                      
                           439     ; SerialInterruptHandler
                           440     ;
                           441     ; Description:       This function handles the 4 interrupts: modem, transmitter,
                           442     ;                    data ready, and receiver line status. The interrupts are
                           443     ;                    handled via a jump table with level triggering. After the
                           444     ;                    interrupt is handled, an EOI value is sent to the EOI
                           445     ;                    address.
                           446     ;
                           447     ; Operation:         The function first reads the value stored in the IIR.
                           448     ;                    If any interrupt bits are set, the function looks at the
                           449     ;                    appropriate handler function for the specific interrupt via
                           450     ;                    the jump table. Afterwards, an EOI vaue is sent to the EOI.
                           451     ;
                           452     ; Arguments:         None.
                           453     ; Return Value:      None.
                           454     ;
                           455     ; Local Variables:   None.
                           456     ; Shared Variables:  None.
                           457     ; Global Variables:  None.
                           458     ;
                           459     ; Input:             None.
                           460     ; Output:            None.
                           461     ;
                           462     ; Error Handling:    None.
                           463     ;
                           464     ; Algorithms:        None.
                           465     ; Data Structures:   None.
                           466     ;
                           467     ; Registers Changed: AX, DB, DX
                           468     ;
                           469     ; Author:            Nancy Cao
                           470     ; Revision History:
                           471     ;     11/17/15  Nancy Cao   initial comments and pseudocode
                           472     ;     11/24/15  Nancy Cao   initial code
                           473     ;     11/30/15  Nancy Cao   updated comments
                           474     
008E                       475     SerialInterruptHandler   PROC        NEAR
                           476                              PUBLIC      SerialInterruptHandler
                           477     
008E 60                    478         PUSHA                           ; save all registers and flags
                           479         
008F BA0201                480         MOV     DX, SERIAL_IIR          ; get the IIR address to see interrupt
0092 EC                    481         IN      AL, DX                  ; read in the value in IIR
0093 2407                  482         AND     AL, IIR_MASK            ; check the bits to see interrupt occurred
0095 3C01                  483         CMP     AL, 1                   ; check if an interrupt occurred
0097 7410                  484         JE      FinishHandling          ; if no interrupt occurred end
                           485         ;JMP    ContinueHandling        ; otherwise continue
                           486         
0099                       487     ContinueHandling:
0099 8AD8                  488         MOV     BL, AL                  ; make IIR an index for the jump table
009B B700                  489         MOV     BH, 0                   ; clear the higher bit of BX for accurate
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE   10


LOC  OBJ                  LINE     SOURCE

                           490                                         ; index
009D 2EFF97E200     R      491         CALL    CS:Jump_Table[BX]       ; calls function to clear specific interrupt
                           492         
00A2 BA22FF                493         MOV     DX, EOI                 ; address of EOI
00A5 B80E00                494         MOV     AX, EOI_VALUE           ; the value that should be in EOI
00A8 EE                    495         OUT     DX, AL                  ; move EOI value to appropriate address
                           496         ;JMP    FinishHandling
                           497         
00A9                       498     FinishHandling:
00A9 61                    499         POPA                            ; pop all registers and flags
                           500         
00AA CF                    501         IRET
                           502                                         
                           503     SerialInterruptHandler    ENDP
                           504     
                           505     ; ModemStatus
                           506     ;
                           507     ; Description:       This function handles the modem status interrupt by
                           508     ;                    looking up the status of the modem control
                           509     ;                    register and getting the current status. This must be
                           510     ;                    read to move on to the other interrupts.
                           511     ;
                           512     ; Operation:         The function simply reads in the status of the modem stored
                           513     ;                    in MSR.
                           514     ;
                           515     ; Arguments:         None.
                           516     ; Return Value:      None.
                           517     ;
                           518     ; Local Variables:   None.
                           519     ; Shared Variables:  None.
                           520     ; Global Variables:  None.
                           521     ;
                           522     ; Input:             None.
                           523     ; Output:            None.
                           524     ;
                           525     ; Error Handling:    None.
                           526     ;
                           527     ; Algorithms:        None.
                           528     ; Data Structures:   None.
                           529     ;
                           530     ; Registers Changed: None.
                           531     ;
                           532     ; Author:            Nancy Cao
                           533     ; Revision History:
                           534     ;     11/24/15  Nancy Cao   initial code
                           535     ;     11/30/15  Nancy Cao   updated comments
                           536     
00AB                       537     ModemStatus  PROC        NEAR
                           538                  PUBLIC      ModemStatus
                           539                  
00AB BA0401                540         MOV     DX, SERIAL_MCR          ; get the MSR address to clear interrupt
00AE EC                    541         IN      AL, DX                  ; get modem status
                           542         
00AF C3                    543         RET
                           544     
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE   11


LOC  OBJ                  LINE     SOURCE

                           545     ModemStatus  ENDP
                           546     
                           547     ; Transmitter
                           548     ;
                           549     ; Description:       This function handles the trasmitter interrupt by
                           550     ;                    attempting to dequeue from the queue. If the queue
                           551     ;                    is empty, the kickstart is just set for the next character.
                           552     ;                    If not, a character is dequeued from the event queue and
                           553     ;                    put into the THR.
                           554     ;
                           555     ; Operation:         The function first checks if the queue is empty. If so,
                           556     ;                    it will set the kickstart and return. Otherwise, it will
                           557     ;                    dequeue the next character in the queue, and put the
                           558     ;                    dequeued character into THR.
                           559     ;
                           560     ; Arguments:         None.
                           561     ; Return Value:      None.
                           562     ;
                           563     ; Local Variables:   None.
                           564     ; Shared Variables:  None.
                           565     ; Global Variables:  None.
                           566     ;
                           567     ; Input:             None.
                           568     ; Output:            None.
                           569     ;
                           570     ; Error Handling:    None.
                           571     ;
                           572     ; Algorithms:        None.
                           573     ; Data Structures:   None.
                           574     ;
                           575     ; Registers Changed: None.
                           576     ;
                           577     ; Author:            Nancy Cao
                           578     ; Revision History:
                           579     ;     11/24/15  Nancy Cao   initial code
                           580     ;     11/30/15  Nancy Cao   updated comments
                           581     
00B0                       582     Transmitter    PROC       NEAR
                           583                   PUBLIC     Transmitter
                           584         
00B0 BE000090       R      585         MOV      SI, OFFSET(tx)     ; pass in address of the transfer queue at DS:SI
00B4 E80000         E      586         CALL     QueueEmpty         ; check if the queue is empty
00B7 7402                  587         JZ       EmptyQueue         ; if so bring up kickstart
00B9 7509                  588         JNZ      DequeueQueue       ; otherwise try to dequeue
                           589        
00BB                       590     EmptyQueue:
00BB C60605010190   R      591         MOV     kickstart, 1        ; flag kickstart to occur
00C1 EB0890                592         JMP     FinishTransmitter   ; and we are done
                           593     
00C4                       594     DequeueQueue:
00C4 E80000         E      595         CALL    Dequeue             ; dequeue next character in queue
00C7 BA0001                596         MOV     DX, SERIAL_THR      ; address of the THR register
00CA EE                    597         OUT     DX, AL              ; output the dequeued character into THR
                           598         ;JMP    FinishTrasmitter    ; and we are done
                           599         
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE   12


LOC  OBJ                  LINE     SOURCE

00CB                       600     FinishTransmitter:
00CB C3                    601         RET
                           602         
                           603     Transmitter    ENDP
                           604     
                           605     ; DataReadyTimeout
                           606     ;
                           607     ; Description:       This function looks up the value stored in RBR and
                           608     ;                    add it to the event queue.
                           609     ;
                           610     ; Operation:         The function reads in the value from the RBR register
                           611     ;                    and passes it into the event queue along with the event
                           612     ;                    value by using the EnqueueEvent function.
                           613     ;                    
                           614     ;
                           615     ; Arguments:         None.
                           616     ; Return Value:      None.
                           617     ;
                           618     ; Local Variables:   None.
                           619     ; Shared Variables:  None.
                           620     ; Global Variables:  None.
                           621     ;
                           622     ; Input:             None.
                           623     ; Output:            None.
                           624     ;
                           625     ; Error Handling:    None.
                           626     ;
                           627     ; Algorithms:        None.
                           628     ; Data Structures:   None.
                           629     ;
                           630     ; Registers Changed: AX, DX
                           631     ;
                           632     ; Author:            Nancy Cao
                           633     ; Revision History:
                           634     ;     11/24/15  Nancy Cao   initial code
                           635     ;     11/30/15  Nancy Cao   updated comments
                           636     
00CC                       637     DataReadyTimeout  PROC    NEAR
                           638                       PUBLIC  DataReadyTimeout
                           639                       
00CC BA0001                640          MOV    DX, SERIAL_RBR      ; address of the RBR register
00CF EC                    641          IN     AL, DX              ; get the value at RBR
00D0 B402                  642          MOV    AH, EVENT_RBR       ; the event value
00D2 E80000         E      643          CALL   EnqueueEvent        ; enqueue value and event value at RBR
                           644          
00D5 C3                    645          RET
                           646          
                           647     DataReadyTimeout  ENDP
                           648     
                           649     ; ReceiverLineStatus
                           650     ;
                           651     ; Description:       This function looks up the value in the LSR to see if there
                           652     ;                    is an error that occured. If so, the error is
                           653     ;                    stored into the event queue.
                           654     ;
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE   13


LOC  OBJ                  LINE     SOURCE

                           655     ; Operation:         The function first reads in the value of the LSR, and
                           656     ;                    masks out the error bits. If an error occured, the error
                           657     ;                    is enqueued aong with the event value for errors.
                           658     ;
                           659     ; Arguments:         None.
                           660     ; Return Value:      None.
                           661     ;
                           662     ; Local Variables:   None.
                           663     ; Shared Variables:  None.
                           664     ; Global Variables:  None.
                           665     ;
                           666     ; Input:             None.
                           667     ; Output:            None.
                           668     ;
                           669     ; Error Handling:    None.
                           670     ;
                           671     ; Algorithms:        None.
                           672     ; Data Structures:   None.
                           673     ;
                           674     ; Registers Changed: AX, DX
                           675     ;
                           676     ; Author:            Nancy Cao
                           677     ; Revision History:
                           678     ;     11/24/15  Nancy Cao   initial code
                           679     ;     11/30/15  Nancy Cao   updated comments
                           680     
00D6                       681     ReceiverLineStatus PROC   NEAR
                           682                        PUBLIC ReceiverLineStatus
                           683                   
00D6 BA0501                684         MOV     DX, SERIAL_LSR     ; address of the LSR register
00D9 EC                    685         IN      AL, DX             ; read in the value at LSR
00DA 241E                  686         AND     AL, ERROR_MASK     ; get the error generated in LSR
00DC B403                  687         MOV     AH, EVENT_ERROR    ; the event value
00DE E80000         E      688         CALL    EnqueueEvent       ; enqueue the error and event value
                           689         
00E1 C3                    690         RET
                           691                   
                           692     ReceiverLineStatus ENDP
                           693     
00E2                       694     Jump_Table        LABEL   WORD
                           695                       PUBLIC  Jump_Table
                           696                       
00E2 AB00           R      697         DW      OFFSET(ModemStatus)          ; modem status interrupt
00E4 B000           R      698         DW      OFFSET(Transmitter)          ; transmitter holding register empty
00E6 CC00           R      699         DW      OFFSET(DataReadyTimeout)     ; receiver data ready/char timeout
00E8 D600           R      700         DW      OFFSET(ReceiverLineStatus)   ; receiver line status
                           701         
----                       702     CODE ENDS    
                           703                
                           704     ;the data segment
                           705     
----                       706     DATA    SEGMENT PUBLIC  'DATA'
                           707     
0000 ??                    708     tx QUEUE <>                          ; transfer queue that stores data
0001 ??
8086/87/88/186 MACRO ASSEMBLER    SERIALR                                                  20:25:12  01/07/;6  PAGE   14


LOC  OBJ                  LINE     SOURCE

0002 ????
0004 ??
0005 (256
     ??
     )
0105 ??                    709     kickstart DB     ?                   ; keeps track of when to handle interrupts
                           710     
----                       711     DATA    ENDS
                           712     
                           713     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
