8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:10:41  01/07/;6  PAGE    1


DOS 5.0 (038-N) 8086/87/88/186 MACRO ASSEMBLER V3.1 ASSEMBLY OF MODULE TIMER
OBJECT MODULE PLACED IN TIMER.OBJ
ASSEMBLER INVOKED BY:  C:\5XTOOLS\ASM86.EXE TIMER.ASM M1 EP DB


LOC  OBJ                  LINE     SOURCE

                             1     NAME    TIMER
                             2     
                             3     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                             4     ;                                                                            ;
                             5     ;                                    TIMER                                   ;
                             6     ;                         RoboTrike Timer Event Handler                      ;
                             7     ;                                   EE/CS 51                                 ;
                             8     ;                                                                            ;
                             9     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                            10     
                            11     ; Description:       This program includes the routines for the RoboTrike
                            12     ;                    timer event handler. The public functions included are:
                            13     ;                        InitTimer2           - initalizes timer 2
                            14     ;                        Timer2EventHandler   - in response to the timer 2
                            15     ;                                               interrupt, the event handler
                            16     ;                                               calls on the keyscan function
                            17     ;                                               from keypad.asm
                            18     ;                        InstallTimer2Handler - installs the timer 2 handler
                            19     ;
                            20     ; Revision History:
                            21     ;     11/01/15  Nancy Cao         initial revision
                            22     ;     11/03/15  Nancy Cao         updated comments
                            23     ;     11/05/15  Nancy Cao         updated comments
                            24     ;     11/08/15  Nancy Cao         updated code/comments for keypad
                            25     ;     11/12/15  Nancy Cao         moved install timer 2 handler from interrupt
                            26     ;                                 file and updated comments
                            27     
                            28     ; local include files
                            29 +1  $INCLUDE(TIMER.INC)        ; display constants for timers
                      =1    30     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    31     ;                                                                            ;
                      =1    32     ;                                  TIMER.INC                                 ;
                      =1    33     ;                              Timer Definitions                             ;
                      =1    34     ;                                 Include File                               ;
                      =1    35     ;                                                                            ;
                      =1    36     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    37     
                      =1    38     ; This file contains the definitions for the timer functions.
                      =1    39     ;
                      =1    40     ; Revision History:
                      =1    41     ;     11/01/15   Nancy Cao      initial revisions and comments
                      =1    42     ;     11/12/15   Nancy Cao      removed some constants and updated comments
                      =1    43     
                      =1    44     ; Interrupt Vectors
  0013                =1    45     Tmr2Vec         EQU     19               ;interrupt vector for Timer 2
                      =1    46     
                      =1    47     ; definitions
                      =1    48     
  FF32                =1    49     INTCtrlrCtrl    EQU     0FF32H          ;address of interrupt controller for timer
  0001                =1    50     INTCtrlrCVal    EQU     00001H          ;set priority for timers to 1 and enable
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:10:41  01/07/;6  PAGE    2


LOC  OBJ                  LINE     SOURCE

                      =1    51                                             ;000000000000----  reserved
                      =1    52                                             ;------------0---  enable timer interrupt
                      =1    53                                             ;-------------001  timer priority
  0008                =1    54     TimerEOI        EQU     00008H          ;Timer EOI command (same for all timers)
  FF66                =1    55     Tmr2Ctrl        EQU     0FF66H          ;address of Timer 2 Control Register
  FF62                =1    56     Tmr2MaxCnt      EQU     0FF62H          ;address of Timer 2 Max Count A Register
  FF60                =1    57     Tmr2Count       EQU     0FF60H          ;address of Timer 2 Count Register
  E001                =1    58     Tmr2CtrlVal     EQU     0E001H          ;value to write to Timer 2 Control Register
                      =1    59                                             ;1---------------  enable timer
                      =1    60                                             ;-1--------------  write to control
                      =1    61                                             ;--1-------------  interrupts
                      =1    62                                             ;----000000-0000-  reserved
                      =1    63                                             ;---0------0-----  read only
                      =1    64                                             ;---------------1  continuous mode
  0900                =1    65     COUNTS_PER_MS   EQU     2304            ;number of timer counts per 1 ms (assumes 18.
                                   432 MHz clock)
                            66 +1  $INCLUDE(INTER.INC)        ; display constants for interrupts
                      =1    67     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    68     ;                                                                            ;
                      =1    69     ;                                  INTER.INC                                 ;
                      =1    70     ;                            Interrupt Definitions                           ;
                      =1    71     ;                                Include File                                ;
                      =1    72     ;                                                                            ;
                      =1    73     ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                      =1    74     
                      =1    75     ; This file contains the definitions for the interrupt functions.
                      =1    76     ;
                      =1    77     ; Revision History:
                      =1    78     ;     11/17/15   Nancy Cao      initial revisions and comments
                      =1    79     
                      =1    80     ; General Definitions
                      =1    81     
  0001                =1    82     FIRST_RESERVED_VEC      EQU     1               ;reserve vectors 1-3
  0003                =1    83     LAST_RESERVED_VEC       EQU     3
  0100                =1    84     NUM_IRQ_VECTORS     EQU     256         ;number of interrupt vectors
  0004                =1    85     VECTOR_SIZE         EQU 4               ; the size of a vector
  0002                =1    86     BYTE_SIZE           EQU 2               ; the size of a byte
  0100                =1    87     TOTAL_VECTOR_NUM    EQU 256             ; the number of vectors to initialize
                      =1    88     
                      =1    89     ; Addresses
                      =1    90     
                      =1    91     ; Register Values
                      =1    92     
  FF22                =1    93     INTCtrlrEOI     EQU     0FF22H          ;address of interrupt controller EOI register
  8000                =1    94     NonSpecEOI      EQU     08000H          ;Non-specific EOI command
                            95     
                            96     EXTRN Keyscan:NEAR         ; scans and debounces pressed keys
                            97     EXTRN Multiplex:NEAR       ; multiplexes the digits on the board
                            98     
                            99     CGROUP  GROUP   CODE
                           100     
                           101     
----                       102     CODE    SEGMENT PUBLIC 'CODE'
                           103     
                           104     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:10:41  01/07/;6  PAGE    3


LOC  OBJ                  LINE     SOURCE

                           105             ASSUME  CS:CGROUP
                           106     
                           107     ; Timer2EventHandler
                           108     ; 
                           109     ; Description: This function reacts to the timer 2 interrupt and calls on the
                           110     ;              multiplex function to determine which digit to display next. It
                           111     ;              then sends the EOI to the interrupt controller and timer
                           112     ;              (COUNTS_PER_MS).
                           113     ;
                           114     ; Operation:   This function simply calls Multiplex, which will write to the
                           115     ;              actual display. Afterwards, it will send the EOI to the interrupt
                           116     ;              controller and to timer 2, then semd timer 2 to the interrupt.
                           117     ;
                           118     ; Arguments: None
                           119     ; Return Value: None.
                           120     ; Local Variables: None.
                           121     ; Shared Variables: None.
                           122     ; Global Variables: None.
                           123     ;
                           124     ; Input: None.
                           125     ; Output: EOI.
                           126     ;
                           127     ; Error Handling: None.
                           128     ;
                           129     ; Limitations: None.
                           130     ;
                           131     ; Algorithms: None.
                           132     ; Data Structures: None.
                           133     ;
                           134     ; Registers Changed: None.
                           135     ;
                           136     ; Author: Nancy Cao
                           137     ; Revision History:
                           138     ;     10/27/15  Nancy Cao        initial comments and pseudocode
                           139     ;     10/31/15  Nancy Cao        initial revision
                           140     ;     11/08/15  Nancy Cao        updated code for keypad
                           141     ;
                           142     
0000                       143     Timer2EventHandler  PROC        NEAR
                           144                        PUBLIC      Timer2EventHandler
                           145                        
0000 60                    146         PUSHA                        ; save current values in registers in stack
                           147     
0001 E80000         E      148         CALL    Keyscan              ; scans the keys to see if any are pressed
0004                       149      Start:
0004 E80000         E      150         CALL    Multiplex
0007 BA22FF                151         MOV     DX, INTCtrlrEOI      ; send the EOI to the interrupt controller
000A B80800                152         MOV     AX, TimerEOI         ; send the EOI to the timer
000D EE                    153         OUT     DX, AL               ; send timer to the interrupt
                           154     
000E 61                    155         POPA                         ; retrieve saved values in stack to registers
                           156         
000F CF                    157         IRET                         ;and return for event handlers
                           158     
                           159     Timer2EventHandler       ENDP
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:10:41  01/07/;6  PAGE    4


LOC  OBJ                  LINE     SOURCE

                           160     
                           161     ; InitTimer2
                           162     ;
                           163     ; Description:       Initialize the 80188 Timer 2.  The timer 2 is initialized
                           164     ;                    to generate interrupts every COUNTS_PER_MS.
                           165     ;                    The interrupt controller is also initialized to allow the
                           166     ;                    timer 2 interrupts.  Timer #2 is used to prescale the
                           167     ;                    internal clock from 2.304 MHz to 1 KHz.
                           168     ;
                           169     ; Operation:         The appropriate values are written to the timer control
                           170     ;                    registers in the PCB.  Also, the timer count registers
                           171     ;                    are reset to zero.  Finally, the interrupt controller is
                           172     ;                    setup to accept timer interrupts and any pending
                           173     ;                    interrupts are cleared by sending a TimerEOI to the
                           174     ;                    interrupt controller.
                           175     ;
                           176     ; Arguments:         None.
                           177     ; Return Value:      None.
                           178     ;
                           179     ; Local Variables:   None.
                           180     ; Shared Variables:  None.
                           181     ; Global Variables:  None.
                           182     ;
                           183     ; Input:             None.
                           184     ; Output:            Timer2config
                           185     ;
                           186     ; Error Handling:    None.
                           187     ;
                           188     ; Algorithms:        None.
                           189     ; Data Structures:   None.
                           190     ;
                           191     ; Registers Changed: AX, DX
                           192     ;
                           193     ; Author:            Nancy Cao
                           194     ; Revision History:
                           195     ;     11/01/15  Nancy Cao   initial revision and comments
                           196     ;     11/05/15  Nancy Cao   updated comments
                           197     
0010                       198     InitTimer2   PROC        NEAR
                           199                  PUBLIC      InitTimer2
                           200     
0010 BA60FF                201             MOV     DX, Tmr2Count   ;initialize the count register to Tmr2Count
0013 33C0                  202             XOR     AX, AX
0015 EE                    203             OUT     DX, AL
                           204     
0016 BA62FF                205             MOV     DX, Tmr2MaxCnt  ;setup max count for 1ms counts
0019 B80009                206             MOV     AX, COUNTS_PER_MS
001C EE                    207             OUT     DX, AL
                           208     
001D BA66FF                209             MOV     DX, Tmr2Ctrl    ;setup the control register with interrupts
0020 B801E0                210             MOV     AX, Tmr2CtrlVal
0023 EE                    211             OUT     DX, AL
                           212     
                           213                                     ;initialize interrupt controller for timers
0024 BA32FF                214             MOV     DX, INTCtrlrCtrl;setup the interrupt control register
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:10:41  01/07/;6  PAGE    5


LOC  OBJ                  LINE     SOURCE

0027 B80100                215             MOV     AX, INTCtrlrCVal
002A EE                    216             OUT     DX, AL
                           217     
002B BA22FF                218             MOV     DX, INTCtrlrEOI ;send a timer EOI (to clear out controller)
002E B80800                219             MOV     AX, TimerEOI
0031 EE                    220             OUT     DX, AL
                           221     
                           222     
0032 C3                    223             RET                     ;done so return
                           224     
                           225     
                           226     InitTimer2      ENDP
                           227     
                           228     ; InstallTimer2Handler
                           229     ;
                           230     ; Description:       Install the event handler for the timer 2 interrupt.
                           231     ;
                           232     ; Operation:         Writes the address of the timer 2 event handler to the
                           233     ;                    appropriate interrupt vector.
                           234     ;
                           235     ; Arguments:         None.
                           236     ; Return Value:      None.
                           237     ;
                           238     ; Local Variables:   None.
                           239     ; Shared Variables:  None.
                           240     ; Global Variables:  None.
                           241     ;
                           242     ; Input:             None.
                           243     ; Output:            None.
                           244     ;
                           245     ; Error Handling:    None.
                           246     ;
                           247     ; Algorithms:        None.
                           248     ; Data Structures:   None.
                           249     ;
                           250     ; Registers Changed: flags, AX, ES
                           251     ;
                           252     ; Author:            Nancy Cao
                           253     ; Revision History:
                           254     ;     11/01/15  Nancy Cao   initial revision and comments
                           255     ;     11/05/15  Nancy Cao   updated comments
                           256     ;     11/12/15  Nancy Cao   updated comments
                           257     
0033                       258     InstallTimer2Handler  PROC    NEAR
                           259                           PUBLIC  InstallTimer2Handler
                           260     
0033 33C0                  261         XOR     AX, AX          ;clear ES (interrupt vectors are in segment 0)
0035 8EC0                  262         MOV     ES, AX
                           263                                     ;store the vector
0037 26C7064C000000 R      264         MOV     ES: WORD PTR (VECTOR_SIZE * Tmr2Vec), OFFSET(Timer2EventHandler)
003E 26C7064E00---- R      265         MOV     ES: WORD PTR (VECTOR_SIZE * Tmr2Vec + BYTE_SIZE), SEG(Timer2EventHandler)
                           266     
                           267     
0045 C3                    268         RET                     ;all done, return
                           269     
8086/87/88/186 MACRO ASSEMBLER    TIMER                                                    20:10:41  01/07/;6  PAGE    6


LOC  OBJ                  LINE     SOURCE

                           270     
                           271     InstallTimer2Handler  ENDP
                           272     
----                       273     CODE ENDS
                           274     
                           275     END

ASSEMBLY COMPLETE, NO ERRORS FOUND
